---
layout: default
title: Layers - Air and Heat
excerpt_separator: <!--more-->
---

Layers
======

### What?

This is a concept for both architecture and gameplay. The idea is very simple: that different subsystems live on different layers "under" the play surface. In this blog I'll write about two of the layers, what they're for, how they work from the player's perspective and how they're implemented. One interesting point is that for the player they're two layers but in the code it's only one layer with two systems running side-by-side.

### Gameplay - Air Layer

It's hard for agents to breathe if there isn't any air. Not being able to breathe is a bummer and the agents will not like it. Maintaining a supply of correctly pressurized air is pretty important to keep the spacecraft habitable. Air flows everywhere except where it's blocked by hull plates or closed hatches. If you want to expand the ship first you have to enclose an area with hull and then let air flow into it. If you want to open the ship to space, say to move something to the outside, you'll want to pull the air out of the area before you open it.

The very basic square test that you'll see in following screenshots is just an outer and inner set of walls. All the air is dropped in a single square and allowed to expand.

![Air with a room](/assets/2022-03-23-layers-air-room.gif)

The player will have to manage pressure with the use of pumps, airlocks, doors and of course hull plates. Air will also be able to move through conduits (a layer for a later blog), be stored in pressurized containers and generated by certain items and of course used by the agents.

Right now "air" is just a single thing, so really it's pressure. Eventually I'll separate it into different gasses: at least CO2 and O2 and maybe some nasty toxics. Adding more gasses is not a hard thing to implement.

### Gameplay - Heat Layer

We always think of space as a very cold place and it is in some sense. A vacuum is, however, also an incredibly good insulator. There are three ways that heat moves around, convection: stuff carrying heat with it to other places, conduction: heat moving though stuff, and radiation: heat moving all by itself no stuff required. The vacuum of space only allows one out of three of those things, radiation. This means that a metal tube surrounded by vacuum will hold on to most of its heat. Heat generated by, say using machines or being alive will mostly just stay in the spacecraft and build up. On the other hand, if the spacecraft isn't generating much internal heat it will eventually radiate away all the heat and cool to space's ambient temperature which is, as I said in the start, very cold.

When machines or people get too hot or too cold they cease to function well and eventually at all. It's important to keep the temperature in a nice range for not dying purposes. The gameplay implications for this are that heat will have to be actively managed, moved around, generated and/or disposed of. Heat will be created by certain (probably most) objects, moved by pumps and conduits and radiated into space.


### Implementation Details

Heat and air are pretty different from a gameplay perspective but their implementations are very similar. The spacecraft is divided up into a grid of cells and each of those cells has a pressure value and a temperature value. Each cell also has a flag that says whether it's a wall or not. The spread of both heat and air is essentially a blurring function. Each square has 8 neighbours and every iteration the total amount of air or heat is totaled and split between all 9 squares. The air diffusion simply gives every elligable square the same amount of air i.e. the average. Walls are simply not processed for air and neighbouring walls are neither counted nor given a share of the air.

![Air Diffusion](/assets/2022-03-23-layers-air.gif)

Heat handling is a bit more complicated and, honestly, I'm not done refining (fixing) how it works so it seems reasonable. I don't want heat to just homogeneously go everywhere it can. I need it to spread at different rates through different things. For example if I treat vacuum the same way I treat walls in the air simulation there will be no radiation into space. That's not realistic and would prevent the simulation of external radiators for dissipating heat into space. I also want walls to conduct heat. So I need differential heat distribution within each 9 square box.

Mathematically it's not hard to do. You just decide what proportion of the total heat each of the 9 squares should get based on their properties. The problem came when I was trying to apportion heat proportionally to pressure. That seemed reasonable, more bits of air means more heat get carried. The problem is, what "pressure" proportion do I give to the walls? I had a hard time finding values that didn't either cause the walls to stay cold or cause them to suck all the heat out of the room. In the end I abandoned the idea of pressure proportionality and just said, if the pressure is above X you get the same proportion as a wall otherwise you get the very low "radiation in a vacuum" value. That seems to give reasonable looking results but as I said more work is needed.

![Heat](/assets/2022-03-23-layers-air-heat.gif)

There's a couple of things to note in this gif. The walls are still wicking heat away, note how none of the high heat in the center actually touches the walls. It does spread out in the center quite nicely and creep faster through the walls than around them. Then there's the way it travels out from the corners. That's a bit weird but it's actually an artifact that the air is spreading in the opposite direction and allowing faster transfer as the pressure goes up. Quite a pretty picture for what that's worth.


### A Charmingly Janky Solution to a Subtlish Problem

When I first implemented the blurring idea I noticed was that when the air spreads out it's a weird shape. It's really asymmetric; it spreads way more down and right than up and left. It doesn't look realistic at all. It had me scratching my head for a while. It turns out that if you just naively iterate over x and y with a nested loop like I'm sure we've all written a thousand times, this is what you get. Imagine the blurring as a thumb that comes down and smushes the air into all 9 neighbouring squares. In this case the thumb is smearing across the page and only dragging the air in one direction. This is ugly and I hate it.

![It's ugly and I hate it](/assets/2022-03-23-layers-air-bad.gif)

I really like the averaging solution though. It's simple; it doesn't require double buffering, it's not some complicated partial share of each square's air to the next iteration (that's the solution from a previous attempt) and best of all it is very easy to tell that it will have the same amount of air from iteration to iteration. But how to get rid of the asymmetry? The charmingly low tech solution that I came up with is just to update the cells in a random order. If you look closely this results in a very lumpy expansion but it's still better than a square. In fact, I'm going to call it billowy instead of lumpy and over a few iterations all the lumps just average out to the circle that I was expecting in the first place. 

![Air Diffusion](/assets/2022-03-23-layers-air.gif)

But charlieb I hear you cry, you can't just generate tens of thousands of random numbers every iteration, what about performance?! I have to answers to this. The first is my favourite programmer tautology, fast enough is fast enough. Performance matters only where it matters and you can't say that it matters here because a) I haven't measured it and 2) there are no requirements anyway. My second answer is that I'm not doing that anyway. I generate a random order of cells one time and just use the same ordering over and over. I did have code to regenerate the order every once in a while but I never enabled it and I don't think I ever will.
